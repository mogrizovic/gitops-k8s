apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: kaniko-build-image
spec:
  entrypoint: kaniko-build-loop
  templates:
  - name: kaniko-build-loop
    serviceAccountName: argo-workflow
    inputs:
      parameters:
      - name: image_name
      - name: image_variant
      - name: repo
      - name: commit_message
    steps:
      - - name: calculate-version
          template: calculate-image-tag
          arguments:
            parameters:
            - name: commit_message
              value: "{{inputs.parameters.commit_message}}"
            - name: image_name
              value: "{{inputs.parameters.image_name}}"

      - - name: kaniko-build
          template: kaniko-build
          arguments:
            parameters:
            - name: image_name
              value: "{{inputs.parameters.image_name}}"
            - name: image_tag
              value: "{{steps.calculate-version.outputs.parameters.next_tag}}"
            - name: image_variant
              value: "{{inputs.parameters.image_variant}}"
            - name: repo
              value: "{{inputs.parameters.repo}}"
            - name: arch
              value: "{{item}}"
          withItems:
            - arm64
            - amd64

      - - name: manifest-tool
          template: manifest-tool
          arguments:
            parameters:
            - name: image_name
              value: "{{inputs.parameters.image_name}}"
            - name: image_tag
              value: "{{steps.calculate-version.outputs.parameters.next_tag}}"
            - name: image_variant
              value: "{{inputs.parameters.image_variant}}"
            - name: platforms
              value: "linux/amd64,linux/arm64"
            - name: repo
              value: "{{inputs.parameters.repo}}"

  - name: kaniko-build
    inputs:
      parameters:
      - name: image_name
      - name: image_tag
      - name: image_variant
      - name: arch
      - name: repo
    volumes:
      - name: kaniko-secret
        secret:
          secretName: dockercred
          items:
            - key: .dockerconfigjson
              path: config.json
    nodeSelector:
      kubernetes.io/arch: "{{inputs.parameters.arch}}"
    serviceAccountName: argo-workflow
    container:
      image: gcr.io/kaniko-project/executor:latest
      args:
      - "--context=git://github.com/{{inputs.parameters.repo}}"
      - '--destination={{inputs.parameters.image_name}}:{{inputs.parameters.image_tag}}{{if inputs.parameters.image_variant == ""}}""{{else}}-{{inputs.parameters.image_variant}}{{end}}-{{inputs.parameters.arch}}'
      volumeMounts:
      - name: kaniko-secret
        mountPath: /kaniko/.docker

  - name: manifest-tool
    inputs:
      parameters:
      - name: image_name
      - name: image_tag
      - name: image_variant
      - name: platforms
    serviceAccountName: argo-workflow
    container:
      image: mplatform/manifest-tool:alpine
      command: ["/bin/sh", "-c"]
      args:
        - >
          manifest-tool --username=$USERNAME --password=$PASSWORD push
          from-args --platforms {{inputs.parameters.platforms}}
          --template {{inputs.parameters.image_name}}:{{inputs.parameters.image_tag}}{{if inputs.parameters.image_variant == ""}}""{{else}}-{{inputs.parameters.image_variant}}{{end}}-ARCH
          --target {{inputs.parameters.image_name}}:{{inputs.parameters.image_tag}}{{inputs.parameters.image_variant}}
      env:
        - name: USERNAME
          valueFrom:
            secretKeyRef:
              name: dockerhub-auth
              key: username
        - name: PASSWORD
          valueFrom:
            secretKeyRef:
              name: dockerhub-auth
              key: password

  - name: calculate-image-tag
    inputs:
      parameters:
        - name: image_name      # e.g. ogrizovicm/spring-boot-example
        - name: commit_message  # e.g. "MINOR: Add new endpoint"
    outputs:
      parameters:
        - name: next_tag
          valueFrom:
            path: /tmp/next_tag.txt
    serviceAccountName: argo-workflow
    script:
      image: ogrizovicm/alpine-curl-jq:1.0.0
      command: [sh]
      source: |
        set -e

        REPO="{{inputs.parameters.image_name}}"

        USER=$(echo "$REPO" | cut -d/ -f1)
        IMAGE=$(echo "$REPO" | cut -d/ -f2)

        TAGS=$(curl -s "https://hub.docker.com/v2/repositories/$USER/$IMAGE/tags?page_size=10" | jq -r '.results[].name' || echo "")

        # Fallback to 0.0.1 if no tags found
        if [ -z "$TAGS" ]; then
          echo "0.0.1" > /tmp/next_tag.txt
          exit 0
        fi

        # Filter only semver-valid tags and strip 'v' prefix if present
        LATEST=$(echo "$TAGS" | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | sed 's/^v//' | sort -V | tail -n 1)

        MAJOR=$(echo "$LATEST" | cut -d. -f1)
        MINOR=$(echo "$LATEST" | cut -d. -f2)
        PATCH=$(echo "$LATEST" | cut -d. -f3)

        COMMIT_MSG=$(echo "{{inputs.parameters.commit_message}}" | tr '[:lower:]' '[:upper:]')

        # Default bump is NO
        BUMP="no"

        # Check commit message prefix
        case "$COMMIT_MSG" in
          MAJOR:*)
            BUMP="major"
            ;;
          MINOR:*)
            BUMP="minor"
            ;;
          PATCH:*)
            BUMP="patch"
            ;;
          *)
            BUMP="no"
            ;;
        esac

        # Bump version accordingly
        case "$BUMP" in
          major)
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            ;;
          minor)
            MINOR=$((MINOR + 1))
            PATCH=0
            ;;
          patch)
            PATCH=$((PATCH + 1))
            ;;
        esac

        # Construct next tag
        NEXT_TAG="$MAJOR.$MINOR.$PATCH"
        echo "Bump type: $BUMP -> Next tag: $NEXT_TAG"

        # Output to file so it can be passed to next step
        echo -n "$NEXT_TAG" > /tmp/next_tag.txt
        exit 0
